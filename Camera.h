#pragma once
#include "Component.h"

#define ASPECT_RATIO				(float(FRAME_BUFFER_WIDTH) / float(FRAME_BUFFER_HEIGHT))

//-----------------------------[Class Declaration]-----------------------------//
class GameObject;
//-----------------------------------------------------------------------------//


struct VS_CB_CAMERA_INFO
{
	Vec4x4 mView{};			// View 행렬
	Vec4x4 mProjection{};	// Projection 행렬
	Vec3 mPosition{};		// 카메라 위치
};












class Camera : public Component {
	COMPONENT(Component, Camera)

private:
	Vec4x4 mViewTransform = Matrix4x4::Identity();
	Vec4x4 mProjectionTransform = Matrix4x4::Identity();

	// Camera Constant Buffer
	ComPtr<ID3D12Resource> mCBCamera{};
	VS_CB_CAMERA_INFO* mCBMap_Camera{};

	Vec3 mOffset{};

	BoundingFrustum mFrustumView{};
	BoundingFrustum mFrustumWorld{};

	D3D12_VIEWPORT mViewport = { 0, 0, FRAME_BUFFER_WIDTH , FRAME_BUFFER_HEIGHT, 0.0f, 1.0f };
	D3D12_RECT mScissorRect = { 0, 0, FRAME_BUFFER_WIDTH , FRAME_BUFFER_HEIGHT };

public:
	//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	///// [ Constructor ] /////

	//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	///// [ Getter ] /////

	Vec3 GetOffset() { return mOffset; }

	//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	///// [ Setter ] /////
	void SetOffset(Vec3 xmf3Offset) { mOffset = xmf3Offset; }

	//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	///// [ Others ] /////

	virtual void Start() override;
	virtual void Release() override;

	/* Shader Variables */
	virtual void CreateShaderVariables();
	virtual void ReleaseShaderVariables();
	virtual void UpdateShaderVariables();

	/* View Matrix */
	void GenerateViewMatrix();
	void RegenerateViewMatrix();
	void GenerateProjectionMatrix(float nearPlaneDistance, float farPlaneDistance, float aspectRatio, float fovAngle);

	/* Viewport */
	void SetViewport(int xTopLeft, int yTopLeft, int width, int height, float minZ = 0.0f, float maxZ = 1.0f);
	void SetScissorRect(LONG xLeft, LONG yTop, LONG xRight, LONG yBottom);

	virtual void SetViewportsAndScissorRects();

	/* Transform */
	void LookAt(const Vec3& lookAt, const Vec3& up);

	/* Frustum */
	void CalculateFrustumPlanes();
	bool IsInFrustum(const BoundingBox& boundingBox);
	bool IsInFrustum(const BoundingOrientedBox& boundingBox);
	bool IsInFrustum(const BoundingSphere& boundingSphere);
	bool IsInFrustum(rsptr<const GameObject> object);
};






class CameraObject : public Object {
protected:
	float mMovingSpeed{};
	sptr<Camera> mCamera{};

public:
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	///// [ Constructor ] /////

	CameraObject();
	virtual ~CameraObject() = default;

	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	///// [ Getter ] /////

	rsptr<Camera> GetCamera() const { return mCamera; }
	float GetMovingSpeed() const { return mMovingSpeed; }

	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	///// [ Setter ] /////

	void SetMovingSpeed(float speed) { mMovingSpeed = speed; }


	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	///// [ Others ] /////

	/* Transform */
	void Rotate(float pitch = 0.0f, float yaw = 0.0f, float roll = 0.0f);

	/* Camera */
	virtual void LookAt(const Vec3& lookAt, const Vec3& up);
};






class MainCameraObject : public CameraObject {
	SINGLETON_PATTERN(MainCameraObject)

private:
	GameObject* mPlayer{};

public:
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	///// [ Constructor ] /////

	MainCameraObject() = default;
	virtual ~MainCameraObject() = default;

	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	///// [ Getter ] /////

	Vec3 GetPlayerPos() const;
	GameObject* GetPlayer() const { return mPlayer; }


	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	///// [ Setter ] /////

	void SetPlayer(rsptr<GameObject> player) { mPlayer = player.get(); }


	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	///// [ Others ] /////

	/* Object */
	virtual void Start() override;

	/* Camera */
	virtual void LookAt(const Vec3& lookAt);
	virtual void LookPlayer();
};

#define mainCameraObject MainCameraObject::Inst()
#define mainCamera mainCameraObject->GetCamera()