//-----------------------------------------------------------------------------
// File: Shader.h
//-----------------------------------------------------------------------------

#pragma once
#include "Object.h"

class CModelObjectMesh;
class Camera;
class CMesh;

class CMaterial;

struct MATERIAL;

struct CB_GAMEOBJECT_INFO
{
	Vec4x4 mWorldTransform{};
};

struct VS_VB_INSTANCE
{
	Vec4x4 mLocalTransform{};
	Vec4 mColor{};
};






// [ CShader ] //
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
class CShader {
private:
	bool mIsClosed{ true };

protected:
	std::vector<ComPtr<ID3D12PipelineState>> mPipelineStates;

	ComPtr<ID3DBlob> mVertexShaderBlob{};
	ComPtr<ID3DBlob> mPixelShaderBlob{};

	D3D12_GRAPHICS_PIPELINE_STATE_DESC	mPipelineStateDesc{};

public:
	CShader();
	virtual ~CShader();

	virtual D3D12_INPUT_LAYOUT_DESC CreateInputLayout();
	virtual D3D12_RASTERIZER_DESC CreateRasterizerState();
	virtual D3D12_BLEND_DESC CreateBlendState();
	virtual D3D12_DEPTH_STENCIL_DESC CreateDepthStencilState();

	virtual D3D12_SHADER_BYTECODE CreateVertexShader();
	virtual D3D12_SHADER_BYTECODE CreatePixelShader();

	constexpr virtual D3D12_PRIMITIVE_TOPOLOGY_TYPE GetPrimitiveType() const { return D3D12_PRIMITIVE_TOPOLOGY_TYPE_TRIANGLE; };

	D3D12_SHADER_BYTECODE CompileShaderFromFile(const std::wstring& fileName, LPCSTR shaderName, LPCSTR shaderProfile, ComPtr<ID3DBlob>& shaderBlob);
	D3D12_SHADER_BYTECODE ReadCompiledShaderFile(const std::wstring& fileName, ComPtr<ID3DBlob>& shaderBlob);

	virtual void CreateShader();
	virtual void CreateShader(UINT renderTargetCnt, DXGI_FORMAT* rtvFormats, DXGI_FORMAT dsvFormat);

	virtual void CreateShaderVariables();
	virtual void UpdateShaderVariables();
	virtual void ReleaseShaderVariables();

	virtual void OnPrepareRender(int pipelineStateIndex = 0);
	virtual void Render(int pipelineStateIndex = 0);

	virtual void UpdateShaderVariable(Vec4x4* world) { }
	virtual void UpdateShaderVariable(MATERIAL* material) { }

	void Close();
};










// [ CWireShader ] //
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
class CWireShader : public CShader {
public:
	CWireShader();
	virtual ~CWireShader();

	virtual void CreateShader();
	virtual D3D12_INPUT_LAYOUT_DESC CreateInputLayout();
	virtual D3D12_RASTERIZER_DESC CreateRasterizerState();

	virtual D3D12_SHADER_BYTECODE CreateVertexShader();
	virtual D3D12_SHADER_BYTECODE CreatePixelShader();

	constexpr virtual D3D12_PRIMITIVE_TOPOLOGY_TYPE GetPrimitiveType() const { return D3D12_PRIMITIVE_TOPOLOGY_TYPE_LINE; };
};










// [ CInstancingShader ] //
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
class CInstancingShader : public CShader {
	using INSTANCE_BUFFER = VS_VB_INSTANCE;

protected:
	std::vector<sptr<CGameObject>> mObjects{};
	ComPtr<ID3D12Resource> mInstBuffer{};
	INSTANCE_BUFFER* mMappedObjects{};
	sptr<const CMesh> mMesh;

	template<class Pred>
	void DoAllObjects(Pred pred)
	{
		for (const auto& object : mObjects) {
			pred(object);
		}
	}

public:
	CInstancingShader();
	virtual ~CInstancingShader();

	std::vector<sptr<CGameObject>>& GetObjects() { return mObjects; }

	virtual D3D12_INPUT_LAYOUT_DESC CreateInputLayout();
	virtual D3D12_SHADER_BYTECODE CreateVertexShader();
	virtual D3D12_SHADER_BYTECODE CreatePixelShader();
	virtual void CreateShader();
	virtual void CreateShaderVariables();
	virtual void UpdateShaderVariables();
	virtual void ReleaseShaderVariables();

	virtual void Render();

	virtual void Start();
	virtual void Update();

	void SetColor(const Vec3& color);

	void BuildObjects(size_t instanceCount, rsptr<const CMesh> mesh);
};





// [ CEffectShader ] //
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
class CEffectShader : public CInstancingShader {
protected:
	using CInstancingShader::BuildObjects;

	// mObjects를 그룹으로 나눈다.
	// 활성화된 그룹
	// <begin, duration>
	std::unordered_map<size_t, float> mActiveGroups{};
	size_t mGroupSize{};
	size_t mCountPerGroup{};

	float mMaxDuration{};

	// 시간 초과 객체 관리
	std::vector<size_t> timeOvers{};

	size_t GetGroupBegin(size_t index);

	template<class Pred>
	void DoActivatedObjects(Pred pred)
	{
		for (auto& [begin, duration] : mActiveGroups) {
			size_t index = begin;
			size_t end = begin + mCountPerGroup;
			for (; index < end; ++index) {
				pred(mObjects[index]);
			}
		}
	}


public:
	CEffectShader();
	virtual ~CEffectShader();

	virtual void UpdateShaderVariables();

	virtual void Render();

	virtual void Update();

	void SetDuration(float duration) { mMaxDuration = duration; }
	void SetColor(size_t i, const Vec3& color);

	void BuildObjects(size_t groupCount, size_t countPerGroup, rsptr<const CModelObjectMesh> mesh);

	// return the activated group
	void SetActive(const Vec3& pos);
};




// [ CTexturedEffectShader ] //
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
class CTexturedEffectShader : public CEffectShader {
private:
	sptr<CMaterial> mMaterial;

public:
	virtual D3D12_INPUT_LAYOUT_DESC CreateInputLayout();
	virtual D3D12_SHADER_BYTECODE CreateVertexShader();
	virtual D3D12_SHADER_BYTECODE CreatePixelShader();

	void SetMaterial(rsptr<CMaterial> material) { mMaterial = material; }

	virtual void UpdateShaderVariables();
	virtual void Render();
};


// [ CStaticShader ] //
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
class CStaticShader abstract : public CTexturedEffectShader {
private:
	virtual void BuildObjects() abstract;

public:
	virtual void Create();
};

class CSmallExpEffectShader : public CStaticShader {
private:
	virtual void BuildObjects() override;
};

class CBigExpEffectShader : public CStaticShader {
private:
	virtual void BuildObjects() override;
};






// [ CBulletShader ] //
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
class CBulletShader : public CInstancingShader {
private:
	std::list<sptr<CGameObject>> mBuffer{};

public:
	CBulletShader();
	virtual ~CBulletShader();

	const std::vector<sptr<CGameObject>>& GetObjects() { return mObjects; }
	void BuildObjects(size_t bufferSize, rsptr<const CMasterModel> model, const CObject* owner);
	void SetLifeTime(float bulletLifeTime);
	void SetDamage(float damage);

	void FireBullet(const Vec3& pos, const Vec3& dir, const Vec3& up, float speed);

	virtual void UpdateShaderVariables();

	virtual void Start();
	virtual void Update();
	virtual void Render();

	const std::list<sptr<CGameObject>>* GetBullets() const { return &mBuffer; }
};












// [ CIlluminatedShader ] //
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
class CIlluminatedShader : public CShader {
public:
	CIlluminatedShader();
	virtual ~CIlluminatedShader();

	virtual void CreateShader();

	virtual D3D12_INPUT_LAYOUT_DESC CreateInputLayout();
	virtual D3D12_SHADER_BYTECODE CreateVertexShader();
	virtual D3D12_SHADER_BYTECODE CreatePixelShader();

	virtual void Render(int pipelineStateIndex = 0);
};




// [ CTexturedShader ] //
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
class CTexturedShader : public CShader {
public:
	CTexturedShader();
	virtual ~CTexturedShader();

	virtual void CreateShader();

	virtual D3D12_INPUT_LAYOUT_DESC CreateInputLayout();
	virtual D3D12_SHADER_BYTECODE CreateVertexShader();
	virtual D3D12_SHADER_BYTECODE CreatePixelShader();

};



// [ CObjectInstancingShader ] //
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
class CObjectInstancingShader : public CTexturedShader {
public:
	virtual D3D12_SHADER_BYTECODE CreateVertexShader();
};



// [ CTransparentShader ] //
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
class CTransparentShader : public CTexturedShader {
public:
	virtual D3D12_DEPTH_STENCIL_DESC CreateDepthStencilState();
	virtual D3D12_BLEND_DESC CreateBlendState();
};



// [ CTerrainShader ] //
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
class CTerrainShader : public CShader {
public:
	CTerrainShader();
	virtual ~CTerrainShader();

	virtual void CreateShader();

	virtual D3D12_RASTERIZER_DESC CreateRasterizerState();
	virtual D3D12_INPUT_LAYOUT_DESC CreateInputLayout();
	virtual D3D12_SHADER_BYTECODE CreateVertexShader();
	virtual D3D12_SHADER_BYTECODE CreatePixelShader();

};




// [ CSkyBoxShader ] //
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
class CSkyBoxShader : public CShader {
public:
	CSkyBoxShader();
	virtual ~CSkyBoxShader();

	virtual void CreateShader();

	virtual D3D12_DEPTH_STENCIL_DESC CreateDepthStencilState();

	virtual D3D12_INPUT_LAYOUT_DESC CreateInputLayout();
	virtual D3D12_SHADER_BYTECODE CreateVertexShader();
	virtual D3D12_SHADER_BYTECODE CreatePixelShader();
};



// [ CWaterShader ] //
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
class CWaterShader : public CTexturedShader {
public:
	virtual D3D12_DEPTH_STENCIL_DESC CreateDepthStencilState();
	virtual D3D12_BLEND_DESC CreateBlendState();

	virtual D3D12_SHADER_BYTECODE CreateVertexShader();
	virtual D3D12_SHADER_BYTECODE CreatePixelShader();
};




// [ CPostProcessingShader ] //
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
class CTexture;
class CPostProcessingShader : public CShader
{
private:
	void CreateTextureResources(UINT renderTargetCnt, DXGI_FORMAT* dxgiFormats);
	void CreateSrvs(UINT renderTargetCnt);
	void CreateRtvs(UINT renderTargetCnt, DXGI_FORMAT* dxgiFormats, D3D12_CPU_DESCRIPTOR_HANDLE rtvHandle);

public:
	CPostProcessingShader();
	virtual ~CPostProcessingShader();

	virtual D3D12_DEPTH_STENCIL_DESC CreateDepthStencilState();

	virtual D3D12_SHADER_BYTECODE CreateVertexShader();
	virtual D3D12_SHADER_BYTECODE CreatePixelShader();

	virtual void CreateShader(UINT renderTargetCnt, DXGI_FORMAT* rtvFormats, DXGI_FORMAT dsvFormat);
	virtual void CreateResourcesAndRtvsSrvs(UINT renderTargetCnt, DXGI_FORMAT* dxgiFormats, D3D12_CPU_DESCRIPTOR_HANDLE rtvHandle);

	virtual void OnPrepareRenderTarget(D3D12_CPU_DESCRIPTOR_HANDLE* rtvHandles, D3D12_CPU_DESCRIPTOR_HANDLE* dsvHandle);
	virtual void OnPostRenderTarget();

	virtual void Render();

protected:
	std::vector<sptr<CTexture>> mTextures{};

	std::vector<D3D12_CPU_DESCRIPTOR_HANDLE> mRtvHandles{};

public:
	D3D12_CPU_DESCRIPTOR_HANDLE GetRtvHandle(UINT index) { return mRtvHandles[index]; }
};


class CTextureToFullScreenShader : public CPostProcessingShader
{
public:
	CTextureToFullScreenShader();
	virtual ~CTextureToFullScreenShader();

	virtual D3D12_SHADER_BYTECODE CreateVertexShader();
	virtual D3D12_SHADER_BYTECODE CreatePixelShader();
};



class CBillboardShader : public CTexturedShader {
public:
	virtual void CreateShader();

	virtual D3D12_RASTERIZER_DESC CreateRasterizerState();
	virtual D3D12_BLEND_DESC CreateBlendState();

	virtual D3D12_SHADER_BYTECODE CreateVertexShader();
	virtual D3D12_SHADER_BYTECODE CreatePixelShader();
};

class CSpriteShader : public CBillboardShader {
public:
	virtual D3D12_SHADER_BYTECODE CreateVertexShader();
};



class CCanvasShader : public CTexturedShader {
public:
	virtual void CreateShader();

	virtual D3D12_INPUT_LAYOUT_DESC CreateInputLayout();

	virtual D3D12_RASTERIZER_DESC CreateRasterizerState();
	virtual D3D12_BLEND_DESC CreateBlendState();

	virtual D3D12_SHADER_BYTECODE CreateVertexShader();
	virtual D3D12_SHADER_BYTECODE CreatePixelShader();
};

class CMirrorShader : public CTexturedShader {
private:
	enum class PSO { StencilMirror, ReflectObjects, Transparent };
	std::unordered_map<PSO, ComPtr<ID3D12PipelineState>> mPSOs{};

	virtual D3D12_BLEND_DESC MirrorBlendState();
	virtual D3D12_DEPTH_STENCIL_DESC MirrorDepthStencilDesc();
	virtual D3D12_DEPTH_STENCIL_DESC ReflectDepthStencilDesc();
	virtual D3D12_RASTERIZER_DESC CWCullRasterizerDesc();
	virtual D3D12_BLEND_DESC TranspaerntBlendState();

	void CreatePiepeLineStates();

	XMMATRIX mMtxReflect{};
	std::shared_ptr<CGameObject> mMirror{};
	Vec4 mMirrorPlane{};

	bool isRenderReflectObject;
public:
	virtual void CreateShader();
	void SetMirrorObject(rsptr<CGameObject> mirror);

	const XMMATRIX& GetReflect() const { return mMtxReflect; }
	virtual D3D12_BLEND_DESC CreateBlendState();
	virtual D3D12_DEPTH_STENCIL_DESC CreateDepthStencilState();

	void Render();

	bool IsRenderReflectObject() { return isRenderReflectObject; }
};